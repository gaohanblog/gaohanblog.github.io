<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-center-simple.min.css?v=1.0.2">



















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">

<link rel="stylesheet" href="/css/main.css?v=7.2.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/ffavicon32.ico?v=7.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon32.ico?v=7.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.2.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.2.0',
    sidebar: {"position":"left","display":"post","offset":15,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    copycode: {"enable":false,"show_result":false,"style":null},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    }
  };
</script>



  <meta name="description" content="gratitude and love">
<meta property="og:type" content="website">
<meta property="og:title" content="To be or not to be?">
<meta property="og:url" content="http://yoursite.com/page/20/index.html">
<meta property="og:site_name" content="To be or not to be?">
<meta property="og:description" content="gratitude and love">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="To be or not to be?">
<meta name="twitter:description" content="gratitude and love">



  <link rel="alternate" href="/atom.xml" title="To be or not to be?" type="application/atom+xml">



  
  
  <link rel="canonical" href="http://yoursite.com/page/20/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>To be or not to be?</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>
<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">To be or not to be?</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">刷题学习笔记</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>about me</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>

      
      
    </ul>
  

  

  
</nav>



</div>
    </header>

    
  
  

  

  <a href="https://github.com/gaohanblog/gaohanblog.github.io" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewbox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/14/01-线程基本知识/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Gh">
      <meta itemprop="description" content="gratitude and love">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="To be or not to be?">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/10/14/01-线程基本知识/" class="post-title-link" itemprop="url">01-线程基本知识</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-10-14 22:07:48" itemprop="dateCreated datePublished" datetime="2019-10-14T22:07:48+08:00">2019-10-14</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a></span>

                
                
                  ，
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java/多线程/" itemprop="url" rel="index"><span itemprop="name">多线程</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">3.7k</span>
            </span>
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">3 分钟</span>
            </span>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="start-和run-方法的区别"><a href="#start-和run-方法的区别" class="headerlink" title="start()和run()方法的区别"></a><font color="#8B475D">start()和run()方法的区别</font></h2><p>我们先看一个小栗子：</p>
<p><img src="http://blog-picture-g.test.upcdn.net/thread/thread1-1.png" alt="image"></p>
<p>从主函数中创建一个线程，并且以<code>t.run()</code>的方式调用，从输出结果可以看出，java是默认开启主线程来执行的。所以我们用t.run()去执行的时候，只是相当于简单的函数调用，因为从打印结果可以看出都是main进程，那么，实质上并没有新建一个子线程。</p>
<p>假如用<code>t.start()</code>来调用那：</p>
<p><img src="http://blog-picture-g.test.upcdn.net/thread/thread1-2.png" alt="image"></p>
<p>那么，从表象上我们已经知道，<code>run</code>只是简单的函数调用，<code>start</code>才会真正地开启一个新线程来执行，下面来看看<code>start()</code>的基本实现方式。</p>
<p><img src="http://blog-picture-g.test.upcdn.net/thread/thread1-3.png" alt="image"></p>
<p>可以看到<code>start</code>方法里面调用了<code>start0</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">start0</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>而<code>start0</code>方法是一个<code>native</code>方法,IDEA已经看不了了，我们去<code>openJDK</code>看看:</p>
<p>找到 <a href="http://hg.openjdk.java.net/jdk8u/jdk8u/jdk/file/f0b93fbd8cf8/src/share/native/java/lang/Thread.c" target="_blank" rel="noopener">Thread.c</a>的源码：</p>
<p><img src="http://blog-picture-g.test.upcdn.net/thread/thread1-4.png" alt="image"></p>
<p>找到了<code>JVM_StartThread</code>方法，但是他放在一个数组里面，没有找到他的实现，所以应该在引入的<code>jvm.h</code>库里面，找打 <a href="http://hg.openjdk.java.net/jdk8u/jdk8u/hotspot/file/76a9c9cf14f1/src/share/vm/prims/jvm.cpp" target="_blank" rel="noopener">jvm.cpp</a>:</p>
<p><img src="http://blog-picture-g.test.upcdn.net/thread/thread1-5.jpg" alt="image"></p>
<p>😤😤😤😤enmmm，虽然看不大懂但是我们确实看到start()方法会调用虚拟机去创建一个新线程，然年再去调用<code>run()</code>方法去执行。所以流程图如下：</p>
<p><img src="http://blog-picture-g.test.upcdn.net/thread/thread1-6.png" alt="image"></p>
<p>最终总结：</p>
<ul>
<li>调用<code>start()</code>方法会创建一个新的子线程并启动</li>
<li><code>run()</code>方法只是<code>thread</code>的一个普通方法的调用</li>
</ul>
<p>以上分析参考自： <a href="https://blog.csdn.net/qq_18657175/article/details/89735886" target="_blank" rel="noopener">源码层面解析Thread中run()和start()的区别？</a></p>
<h2 id="Thread和Runnable是什么关系"><a href="#Thread和Runnable是什么关系" class="headerlink" title="Thread和Runnable是什么关系"></a><font color="#8B475D">Thread和Runnable是什么关系</font></h2><p>我们先看看<code>Thread</code>这个类：</p>
<p><img src="http://blog-picture-g.test.upcdn.net/thread/thread1-7.png" alt="image"></p>
<p>我们可以看到，<code>Thread</code>是一个<code>class</code>，而<code>Runnable</code>是一个<code>interface</code>，而<code>Runnable</code>中只有一个抽象方法就是<code>run()</code>。</p>
<p>那么，我们上面说到，新建一个线程是要靠<code>start()</code>来实现的，那么<code>Runnable</code>是如何来新建一个线程呢？它不是只有一个<code>run()</code>方法吗？</p>
<p>此时再来看<code>Thread</code>类，它里面有大量的方法，就包含了<code>run()</code>和<code>start()</code>方法，它还有一个重要的构造函数为:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Thread</span><span class="params">(Runnable target)</span> </span>&#123;...&#125;</span><br></pre></td></tr></table></figure>

<p>就是说，传入<code>Runable</code>接口的实例。在调用<code>Thread</code>的<code>start()</code>方法创建子线程,再来调用重写<code>run()</code>方法就可以了，下面我们看个栗子。</p>
<p>先说说用<code>Thread</code>的方式来创建一个子线程类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)&#123;</span><br><span class="line">            System.out.println(<span class="string">"current Thread "</span> + name + <span class="string">" is running "</span>+i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        MyThread t1 = <span class="keyword">new</span> MyThread(<span class="string">"thread01"</span>);</span><br><span class="line">        MyThread t2 = <span class="keyword">new</span> MyThread(<span class="string">"thread02"</span>);</span><br><span class="line">        MyThread t3 = <span class="keyword">new</span> MyThread(<span class="string">"thread03"</span>);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t3.start();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">current Thread thread02 is running <span class="number">0</span></span><br><span class="line">current Thread thread02 is running <span class="number">1</span></span><br><span class="line">current Thread thread01 is running <span class="number">0</span></span><br><span class="line">current Thread thread02 is running <span class="number">2</span></span><br><span class="line">current Thread thread02 is running <span class="number">3</span></span><br><span class="line">current Thread thread02 is running <span class="number">4</span></span><br><span class="line">current Thread thread03 is running <span class="number">0</span></span><br><span class="line">current Thread thread01 is running <span class="number">1</span></span><br><span class="line">current Thread thread03 is running <span class="number">1</span></span><br><span class="line">current Thread thread01 is running <span class="number">2</span></span><br><span class="line">current Thread thread03 is running <span class="number">2</span></span><br><span class="line">current Thread thread01 is running <span class="number">3</span></span><br><span class="line">current Thread thread03 is running <span class="number">3</span></span><br><span class="line">current Thread thread01 is running <span class="number">4</span></span><br><span class="line">current Thread thread03 is running <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>可以看出每个线程是交替进行的，但是他们属于同一个进程，共享同一个地址和资源，所以不需要切换，极大的提高了CPU的执行效率。</p>
<p>下面再来看看<code>Runnable</code>接口是怎么实现多线程的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyRunable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyRunable</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)&#123;</span><br><span class="line">            System.out.println(<span class="string">"current Thread "</span> + name + <span class="string">" is running "</span>+i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        MyRunable r1 = <span class="keyword">new</span> MyRunable(<span class="string">"runable1"</span>);</span><br><span class="line">        MyRunable r2 = <span class="keyword">new</span> MyRunable(<span class="string">"runable2"</span>);</span><br><span class="line">        MyRunable r3 = <span class="keyword">new</span> MyRunable(<span class="string">"runable3"</span>);</span><br><span class="line"></span><br><span class="line">        Thread t1 = <span class="keyword">new</span> Thread(r1);</span><br><span class="line">        Thread t2 = <span class="keyword">new</span> Thread(r2);</span><br><span class="line">        Thread t3 = <span class="keyword">new</span> Thread(r3);</span><br><span class="line"></span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t3.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">current Thread runable1 is running <span class="number">0</span></span><br><span class="line">current Thread runable2 is running <span class="number">0</span></span><br><span class="line">current Thread runable2 is running <span class="number">1</span></span><br><span class="line">current Thread runable2 is running <span class="number">2</span></span><br><span class="line">current Thread runable2 is running <span class="number">3</span></span><br><span class="line">current Thread runable2 is running <span class="number">4</span></span><br><span class="line">current Thread runable3 is running <span class="number">0</span></span><br><span class="line">current Thread runable3 is running <span class="number">1</span></span><br><span class="line">current Thread runable3 is running <span class="number">2</span></span><br><span class="line">current Thread runable3 is running <span class="number">3</span></span><br><span class="line">current Thread runable3 is running <span class="number">4</span></span><br><span class="line">current Thread runable1 is running <span class="number">1</span></span><br><span class="line">current Thread runable1 is running <span class="number">2</span></span><br><span class="line">current Thread runable1 is running <span class="number">3</span></span><br><span class="line">current Thread runable1 is running <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>总结一下他们特点：</p>
<ul>
<li>调用<code>start()</code>方法会创建一个新的子线程并启动，<code>run()</code>方法是当前线程一个普通方法的调用。</li>
<li><code>Thread</code>是一个类，<code>Runnable</code>是一个接口，前者实现后者</li>
<li><code>Thread</code>有<code>start</code>方法，结合<code>run()</code>可以实现多线程，但是<code>Runnable</code>没有<code>start()</code>方法，所以要通过<code>Thread()</code>来实现，所以，两种方式最终都是通过<code>Thread</code>的<code>start()</code>来实现<code>run()</code>的多线程特性</li>
<li>由于<code>JAVA</code>是单一继承的，所以推荐多使用<code>Runnable</code>接口</li>
</ul>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/06/11-天气预报系统-熔断机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Gh">
      <meta itemprop="description" content="gratitude and love">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="To be or not to be?">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/10/06/11-天气预报系统-熔断机制/" class="post-title-link" itemprop="url">11-天气预报系统-熔断机制</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-10-06 16:54:11" itemprop="dateCreated datePublished" datetime="2019-10-06T16:54:11+08:00">2019-10-06</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/springcloud/" itemprop="url" rel="index"><span itemprop="name">springcloud</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">8k</span>
            </span>
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">7 分钟</span>
            </span>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在整个系统中，假如城市数据微服务不可用了，那么依赖到城市数据的所有服务都将受到牵连，有可能造成整个系统的雪崩，或者说资源需要聚集在核心业务上，非核心业务就可以适当地关闭，此时就是需要有一种机制来实现系统保护和服务降级的功能。本章介绍hystrix组件。</p>
<h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a><font color="#8B475D">定义</font></h2><p>保护系统的一种方式，当请求超出阈值，把真实的服务接口断开，可能只是返回给你一个默认值。这样，掐断了自己的服务，又可以给用户一个响应。</p>
<blockquote>
<p><font color="#333">对该服务的调用执行熔断，对于后续请求，不再继续调用该目标服务，而是直接返回，从而可以快速释放资源。</font></p>
</blockquote>
<p>熔断器好处：系统稳定、减少性能损耗、及时响应、阈值可配置</p>
<p>熔断器有点像生活中电路中的保险丝，当电路中出现某些异常比如短路或者电流过大保险丝会烧断来保护整个电路，熔断器有类似的原理，但又不完全相同。在互联网系统中，当下游服务因访问压力过大而响应变慢或失败，上游服务为了保护系统整体的可用性，可以暂时切断对下游服务的调用。</p>
<p>这种牺牲局部，保全整体的措施就叫做熔断。</p>
<p>如果不采取熔断措施，我们的系统会怎样呢？我们来看一个栗子。当前系统中有A，B，C三个服务，服务A是上游，服务B是中游，服务C是下游。它们的调用链如下：</p>
<p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher11-1.png" alt="image"></p>
<p>一旦下游服务C因某些原因变得不可用，积压了大量请求，服务B的请求线程也随之阻塞。线程资源逐渐耗尽，使得服务B也变得不可用。紧接着，服务A也变为不可用，整个调用链路被拖垮。</p>
<p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher11-2.png" alt="image"></p>
<p>像这种调用链路的连锁故障，叫做<strong>雪崩</strong>。</p>
<p>在这种时候，就需要我们的熔断机制来挽救整个系统。</p>
<p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher11-3.png" alt="image"></p>
<p><strong>开启熔断</strong>:在固定时间窗口内，接口调用超时比率达到一个阈值，会开启熔断。进入熔断状态后，后续对该服务接口的调用不再经过网络，直接执行本地的默认方法，达到服务降级的效果。</p>
<p><strong>熔断恢复</strong>:熔断不可能是永久的。当经过了规定时间之后，服务将从熔断状态回复过来，再次接受调用方的远程调用。</p>
<h2 id="熔断和降级"><a href="#熔断和降级" class="headerlink" title="熔断和降级"></a><font color="#8B475D">熔断和降级</font></h2><p><strong>熔断</strong>：举个例子解释，生活中每家每户都在用电，小明家的电线因为故障导致了小明家停电了。而小李、小张家的电是正常使用的。电力公司没有因为小明家有故障线路而停掉其他人家的电，同时小明家没有使用有故障的电路的电。这时即为熔断。熔断的目的是当A服务模块中的某块程序出现故障后为了不影响其他客户端的请求而做出的及时回应。</p>
<p><strong>降级</strong>：举个例子解释，我们去银行排队办理业务，大部分的银行分为普通窗口、特殊窗口（VIP窗口，老年窗口）。某一天银行大厅排普通窗口的人巨多。这时特殊窗口贴出告示说某时刻之后再开放。那么这时特殊窗口的工作人员就可以空出来去帮其他窗口办理业务，提高办事效率，已达到解决普通窗口排队的人过的目的。这时即为降级，降级的目的是为了解决整体项目的压力，而牺牲掉某一服务模块而采取的措施。</p>
<p>所以从上述分析来看，两者其实从有些角度看是有一定的类似性的：</p>
<ul>
<li><strong>目的很一致</strong>，都是从可用性可靠性着想，为防止系统的整体缓慢甚至崩溃，采用的技术手段；</li>
<li><strong>最终表现类似</strong>，对于两者来说，最终让用户体验到的是某些功能暂时不可达或不可用；</li>
<li><strong>粒度一般都是服务级别</strong>，当然，业界也有不少更细粒度的做法，比如做到数据持久层（允许查询，不允许增删改）；</li>
<li><strong>自治性要求很高</strong>，熔断模式一般都是服务基于策略的自动触发，降级虽说可人工干预，但在微服务架构下，完全靠人显然不可能，开关预置、配置中心都是必要手段；</li>
</ul>
<p>而两者的区别也是明显的：</p>
<ul>
<li><strong>触发原因不太一样</strong>，服务熔断一般是某个服务（下游服务）故障引起，而服务降级一般是从整体负荷考虑；</li>
<li><strong>管理目标的层次不太一样</strong>，熔断其实是一个框架级的处理，每个微服务都需要（无层级之分），而降级一般需要对业务有层级之分（比如降级一般是从最外围服务开始）</li>
</ul>
<h2 id="Spring-Cloud-Hystrix"><a href="#Spring-Cloud-Hystrix" class="headerlink" title="Spring Cloud Hystrix"></a><font color="#8B475D">Spring Cloud Hystrix</font></h2><p>Spring Cloud Hystrix是基于Netflix的开源框架Hystrix实现，该框架实现了服务熔断、线程隔离等一系列服务保护功能。对于熔断机制的实现，Hystrix设计了三种状态：</p>
<ul>
<li><strong>熔断关闭状态（Closed）</strong>：服务没有故障时，熔断器所处的状态，对调用方的调用不做任何限制。</li>
<li><strong>熔断开启状态（Open）</strong>：在固定时间窗口内（<code>Hystrix</code>默认是10秒），接口调用出错比率达到一个阈值（<code>Hystrix</code>默认为50%），会进入熔断开启状态。进入熔断状态后，后续对该服务接口的调用不再经过网络，直接执行本地的<code>fallback</code>方法。</li>
<li><strong>半熔断状态（Half-Open）</strong>：在进入熔断开启状态一段时间之后（Hystrix默认是5秒），熔断器会进入半熔断状态。所谓半熔断就是尝试恢复服务调用，允许有限的流量调用该服务，并监控调用成功率。如果成功率达到预期，则说明服务已恢复，进入熔断关闭状态；如果成功率仍旧很低，则重新进入熔断关闭状态。</li>
</ul>
<p>集成<code>Hystrix</code>也是很简单的：</p>
<p>将<code>msa-weather-eureka-client-feign</code>服务改造为<code>msa-weather-eureka-client-feign-hystrix</code></p>
<p>1丶引入依赖：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--Hystrix--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>2丶添加注解<code>@EnableCircuitBreaker</code>，启用<code>Hystrix</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@EnableCircuitBreaker</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MicroWeatherEurekaClientApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MicroWeatherEurekaClientApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3丶在controller方法上增加注解@HystrixCommand:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CityController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CityClient cityClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/cities"</span>)</span><br><span class="line">    <span class="meta">@HystrixCommand</span>(fallbackMethod=<span class="string">"defaultCities"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">listCity</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">//通过feign客户端来查找的</span></span><br><span class="line">        String body = cityClient.listCity();</span><br><span class="line">        <span class="keyword">return</span> body;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String  <span class="title">defaultCities</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"本服务现在不可用！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4丶测试</p>
<p>启动<code>eureka server</code>端和城市数据服务，再启动本服务，是正常的。</p>
<p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher11-5.png" alt="image"></p>
<p>那么，我们将城市数据服务关闭，看看有没有返回我们指定的默认值。</p>
<p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher11-6.png" alt="image"></p>
<h2 id="改造本系统"><a href="#改造本系统" class="headerlink" title="改造本系统"></a><font color="#8B475D">改造本系统</font></h2><p>现在我们要改造<code>msa-weather-report-eureka-feign-gateway</code>，将其改造为<code>msa-weather-report-eureka-feign-gateway-hystrix</code>，我们用新的方式，直接在<code>DataClient</code>这个接口里面声明触发熔断时回调的类<code>DataClientFallback.class</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name=<span class="string">"msa-weather-eureka-client-zuul"</span>,fallback = DataClientFallback.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataClient</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取城市列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/city/cities"</span>)</span><br><span class="line">    <span class="function">List&lt;City&gt;  <span class="title">listCity</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据城市Id来查询天气数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cityId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/data/weather/cityId/&#123;cityId&#125;"</span>)</span><br><span class="line">    <span class="function">WeatherResponse <span class="title">getDataByCityId</span><span class="params">(@PathVariable(<span class="string">"cityId"</span>)</span> String cityId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体这个回调的类里面时这样写的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataClientFallback</span> <span class="keyword">implements</span> <span class="title">DataClient</span></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当触发断路器的时候默认返回郑州和新郑两个城市的数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;City&gt; <span class="title">listCity</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        List&lt;City&gt; cityList = <span class="keyword">null</span>;</span><br><span class="line">        cityList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        City city = <span class="keyword">new</span> City();</span><br><span class="line">        city.setCityId(<span class="string">"101180101"</span>);</span><br><span class="line">        city.setCityName(<span class="string">"郑州"</span>);</span><br><span class="line">        cityList.add(city);</span><br><span class="line"></span><br><span class="line">        city = <span class="keyword">new</span> City();</span><br><span class="line">        city.setCityId(<span class="string">"101180106"</span>);</span><br><span class="line">        city.setCityName(<span class="string">"新郑"</span>);</span><br><span class="line">        cityList.add(city);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> cityList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 如果天气采集数据挂掉了返回空</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cityId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> WeatherResponse <span class="title">getDataByCityId</span><span class="params">(String cityId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是说，如果城市数据服务挂了，就默认返回一下我这里设置的城市；如果获取天气信息的服务挂了，我们就直接返回null;</p>
<p>那么，我们就相当于在feign中启用hystrix，就需要在配置文件中增加配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">feign.hystrix.enabled=true</span><br></pre></td></tr></table></figure>

<p>因为如果根据城市id获取天气信息的服务不可用时，我们默认直接返回null，显示页面啥都不显示时不好的，所以我们需要在前端判断一下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">&lt;!--不为空时--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:if</span>=<span class="string">"$&#123;reportModel.report&#125; != null"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h1</span> <span class="attr">class</span>=<span class="string">"text-success"</span> <span class="attr">th:text</span>=<span class="string">"$&#123;reportModel.report.city&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--&lt;p&gt;--&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--    空气质量指数：&lt;span th:text=" $&#123;reportModel.report.aqi&#125;"&gt;&lt;/span&gt;--&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--&lt;/p&gt;--&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">&lt;!--下拉框显示选择城市--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">                    当前温度：<span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">" $&#123;reportModel.report.wendu&#125; + ℃"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span></span><br><span class="line">                    温馨提示：<span class="tag">&lt;<span class="name">span</span> <span class="attr">th:text</span>=<span class="string">"$&#123;reportModel.report.ganmao&#125;"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--展示未来天气--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"card border-info"</span> <span class="attr">th:each</span>=<span class="string">" forecast : $&#123;reportModel.report.forecast&#125;"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"card-body text-info"</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"card-text"</span> <span class="attr">th:text</span>=<span class="string">"$&#123;forecast.date&#125;"</span>&gt;</span>日期<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"card-text"</span> <span class="attr">th:text</span>=<span class="string">"$&#123;forecast.type&#125;"</span>&gt;</span>天气类型<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"card-text"</span> <span class="attr">th:text</span>=<span class="string">"$&#123;forecast.high&#125;"</span>&gt;</span>天气类型<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"card-text"</span> <span class="attr">th:text</span>=<span class="string">"$&#123;forecast.low&#125;"</span>&gt;</span>天气类型<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"card-text"</span> <span class="attr">th:text</span>=<span class="string">"$&#123;forecast.fengxiang&#125;"</span>&gt;</span>天气类型<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">th:if</span>=<span class="string">"$&#123;reportModel.report&#125; == null"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>天气数据API服务暂时不可用！！！<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>下面就来测试一把吧！</p>
<p>首先时完全正常的情况，各个服务都可用：</p>
<p>依次启动如下服务：<code>redis</code>,<code>weather-eureka-server</code>,<code>msa-weather-city-eureka</code>,<code>msa-weather-collection-eureka-feign</code>,<code>msa-weather-data-eureka</code>,<code>msa-weather-report-eureka-feign-gateway-hystrix</code>,<code>msa-eureka-client-zuul</code>这六个服务：</p>
<p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher11-7.png" alt="image"></p>
<p>正常的话，就会看到之前的页面：<a href="http://localhost:8083/report/cityId/101180101" target="_blank" rel="noopener">http://localhost:8083/report/cityId/101180101</a></p>
<p>当城市数据服务不可用，熔断器生效：</p>
<p>关闭城市数据服务<code>msa-weather-city-eureka</code>，造成服务不可用的现象。看页面显示是否只有我塞进去的假数据。</p>
<p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher11-8.png" alt="image"></p>
<p>天气数据服务不可用，熔断器生效：</p>
<p>关闭天气数据API服务<code>msa-weather-data-eureka</code>.看页面是否显示服务暂不可用的提示信息。</p>
<p>中间报了一个空指针错误，原因是<code>msa-weather-report-eureka-feign-gateway-hystrix</code>中<code>WeatherReportServiceImpl</code>中的方法原来是这样写的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherReportServiceImpl</span> <span class="keyword">implements</span> <span class="title">WeatherReportService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataClient dataClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Weather <span class="title">getDataByCityId2</span><span class="params">(String cityId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 改为由天气数据API微服务来获取</span></span><br><span class="line">        WeatherResponse resp = dataClient.getDataByCityId(cityId);</span><br><span class="line">        <span class="keyword">return</span>  resp.getData();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里需要判空操作，否则是不能调用getData()这个方法的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherReportServiceImpl</span> <span class="keyword">implements</span> <span class="title">WeatherReportService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataClient dataClient;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Weather <span class="title">getDataByCityId</span><span class="params">(String cityId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 改为由天气数据API微服务来获取</span></span><br><span class="line">        WeatherResponse resp = dataClient.getDataByCityId(cityId);</span><br><span class="line">        Weather weather = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span>(resp != <span class="keyword">null</span>)&#123;</span><br><span class="line">            weather = resp.getData();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>  weather;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样子，重新启动天气预报UI服务。就可以看到效果啦！</p>
<p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher11-9.png" alt="image"></p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/05/10-天气预报系统-集中化配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Gh">
      <meta itemprop="description" content="gratitude and love">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="To be or not to be?">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/10/05/10-天气预报系统-集中化配置/" class="post-title-link" itemprop="url">09-天气预报系统-集中化配置</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-10-05 16:54:11" itemprop="dateCreated datePublished" datetime="2019-10-05T16:54:11+08:00">2019-10-05</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/springcloud/" itemprop="url" rel="index"><span itemprop="name">springcloud</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">3.8k</span>
            </span>
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">3 分钟</span>
            </span>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>服务拆分之后，配置文件就必然随着这些拆分的服务分散在各个服务器上，，用一个集中化的方式统一进行配置文件的配置与修改是必要的。本章介绍spring config的基本使用.</p>
<h2 id="集中化配置的优势"><a href="#集中化配置的优势" class="headerlink" title="集中化配置的优势"></a><font color="#8B475D">集中化配置的优势</font></h2><p>随着线上项目变的日益庞大，每个项目都散落着各种配置文件，如果采用分布式的开发模式，需要的配置文件随着服务增加而不断增多。某一个基础服务信息变更，都会引起一系列的更新和重启，运维苦不堪言也容易出错。配置中心便是解决此类问题。</p>
<p>我们需要一个外部的、集中化的一个配置中心。</p>
<h2 id="配置分类"><a href="#配置分类" class="headerlink" title="配置分类"></a><font color="#8B475D">配置分类</font></h2><ul>
<li>按配置的来源划分</li>
</ul>
<p>主要有源代码、文件、数据库连接、远程调用等</p>
<ul>
<li>按配置的环境划分</li>
</ul>
<p>主要有开发环境、测试环境、预发布环境、生产环境等。</p>
<ul>
<li>按配置的集成阶段划分</li>
</ul>
<p>编译时、打包时和运行时</p>
<ul>
<li>按配置的加载方式划分</li>
</ul>
<p>启动加载和动态加载</p>
<h2 id="Spring-Cloud-Config"><a href="#Spring-Cloud-Config" class="headerlink" title="Spring Cloud Config"></a><font color="#8B475D">Spring Cloud Config</font></h2><p>在我们了解<code>spring cloud config</code>之前，我可以想想一个配置中心提供的核心功能应该有什么</p>
<ul>
<li>提供服务端和客户端支持</li>
<li>集中管理各环境的配置文件</li>
<li>配置文件修改之后，可以快速的生效</li>
<li>可以进行版本管理</li>
<li>支持大的并发查询</li>
<li>支持各种语言</li>
</ul>
<p><code>Spring Cloud Config</code>可以完美的支持以上所有的需求。</p>
<p><strong><code>Spring Cloud Config</code>项目是一个解决分布式系统的配置管理方案。它包含了<code>Client</code>和<code>Server</code>两个部分，<code>server</code>提供配置文件的存储、以接口的形式将配置文件的内容提供出去，<code>client</code>通过接口获取数据、并依据此数据初始化自己的应用。<code>Spring cloud</code>使用<code>git</code>或<code>svn</code>存放配置文件，默认情况下使用<code>git</code>.</strong></p>
<p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher10-1.png" alt="image"></p>
<h2 id="Server端"><a href="#Server端" class="headerlink" title="Server端"></a><font color="#8B475D">Server端</font></h2><p>注册到<code>eureka</code>的实例名：<code>msa-weather-config-server</code></p>
<h5 id="添加依赖"><a href="#添加依赖" class="headerlink" title="#添加依赖"></a>#<font color="#367bdd">添加依赖</font></h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-config-server&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h5 id="配置文件"><a href="#配置文件" class="headerlink" title="#配置文件"></a>#<font color="#367bdd">配置文件</font></h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server.port=8888</span><br><span class="line">spring.application.name=msa-weather-config-server</span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:8761/eureka/</span><br><span class="line">eureka.client.fetch-registry=true</span><br><span class="line">eureka.client.register-with-eureka=true</span><br><span class="line">spring.cloud.config.server.git.uri=https://github.com/xiaogaohan/spring-cloud-config-center</span><br><span class="line">spring.cloud.config.server.git.search-paths=config-repo</span><br></pre></td></tr></table></figure>

<p><code>config-repo</code>这个文件夹是由自己在<code>github</code>上创建的。在这个目录下新建一个文件：<code>msa-weather-config-client-dev.properties</code>,里面的内容为<code>auther=gh.com</code>(随便写点东西以供测试)</p>
<blockquote>
<p><font color="#333">仓库中的配置文件会被转换成web接口，访问可以参照以下的规则：<br><br><br>/{application}/{profile}[/{label}]<br><br><br>/{application}-{profile}.yml<br><br><br>/{label}/{application}-{profile}.yml<br><br><br>/{application}-{profile}.properties<br><br><br>/{label}/{application}-{profile}.properties</font></p>
</blockquote>
<p>我这里的<code>msa-weather-config-client-dev.properties</code>,它的<code>application</code>是<code>msa-weather-config-client</code>，<code>profile</code>是<code>dev</code>。<code>client</code>会根据填写的参数来选择读取对应的配置。</p>
<p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher10-2.png" alt="image"></p>
<h5 id="启动类"><a href="#启动类" class="headerlink" title="#启动类"></a>#<font color="#367bdd">启动类</font></h5><p>启动类添加<code>@EnableConfigServer</code>，激活对配置中心的支持</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherEurekaClientApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(WeatherEurekaClientApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到此<code>server</code>端相关配置已经完成.</p>
<h5 id="测试"><a href="#测试" class="headerlink" title="#测试"></a>#<font color="#367bdd">测试</font></h5><p>访问 <a href="http://localhost:8888/auther/dev" target="_blank" rel="noopener">http://localhost:8888/auther/dev</a> 返回：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;name&quot;:&quot;auther&quot;,</span><br><span class="line">&quot;profiles&quot;:[&quot;dev&quot;],</span><br><span class="line">&quot;label&quot;:null,</span><br><span class="line">&quot;version&quot;:&quot;7238233698d6234805a161b3f8badaceb425eed4&quot;,</span><br><span class="line">&quot;state&quot;:&quot;null&quot;,</span><br><span class="line">propertySources&quot;:[]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问 <a href="http://localhost:8888/msa-weather-config-client-dev.properties" target="_blank" rel="noopener">http://localhost:8888/msa-weather-config-client-dev.properties</a> 返回配置文件的内容:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auther: gh.com</span><br></pre></td></tr></table></figure>

<p>我们可以读到<code>auther</code>里的内容，说明服务端配置成功。</p>
<h2 id="Client端"><a href="#Client端" class="headerlink" title="Client端"></a><font color="#8B475D">Client端</font></h2><p>注册到<code>eureka</code>的实例名：<code>msa-weather-config-client</code></p>
<h5 id="添加依赖-1"><a href="#添加依赖-1" class="headerlink" title="#添加依赖:"></a>#<font color="#367bdd">添加依赖:</font></h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">		&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">		&lt;artifactId&gt;spring-cloud-starter-config&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h5 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="#配置文件:"></a>#<font color="#367bdd">配置文件:</font></h5><p>需要配置两个配置文件，<code>application.properties</code>和<code>bootstrap.properties</code></p>
<p><code>application.properties</code>如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server.port=8081</span><br><span class="line">spring.application.name=msa-weather-config-client</span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:8761/eureka</span><br></pre></td></tr></table></figure>

<p><code>bootstrap.properties</code>如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spring.cloud.config.name=msa-weather-config-client</span><br><span class="line">eureka.client.service-url.defaultZone=http://localhost:8761/eureka</span><br><span class="line">spring.cloud.config.profile=dev</span><br><span class="line">spring.cloud.config.uri=http://localhost:8888/</span><br><span class="line">spring.cloud.config.label=master</span><br></pre></td></tr></table></figure>

<p><code>spring.application.name</code>：对应{<code>application</code>}部分</p>
<p><code>spring.cloud.config.profile</code>：对应{<code>profile</code>}部分</p>
<p><code>spring.cloud.config.label</code>：对应<code>git</code>的分支。如果配置中心使用的是本地存储，则该参数无用</p>
<p><code>spring.cloud.config.uri</code>：配置中心的具体地址,就是<code>server</code>端地址</p>
<blockquote>
<p><font color="#333">特别注意：上面这些与spring-cloud相关的属性必须配置在bootstrap.properties中，config部分内容才能被正确加载。因为config的相关配置会先于application.properties，而bootstrap.properties的加载也是先于application.properties。</font></p>
</blockquote>
<p>测试：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherEurekaClientApplicationTests</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;auther&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String auther;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Assert.assertEquals(<span class="string">"oursnail.cn"</span>,auther);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试通过，说明获取内容成功。</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/03/09-天气预报系统-API网关/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Gh">
      <meta itemprop="description" content="gratitude and love">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="To be or not to be?">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/10/03/09-天气预报系统-API网关/" class="post-title-link" itemprop="url">09-天气预报系统-API网关</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-10-03 16:54:11" itemprop="dateCreated datePublished" datetime="2019-10-03T16:54:11+08:00">2019-10-03</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/springcloud/" itemprop="url" rel="index"><span itemprop="name">springcloud</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">2.5k</span>
            </span>
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">2 分钟</span>
            </span>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在前面我们实现了服务的注册，发现和消费问题，整个小系统就可以跑起来了，但是对于复杂的系统，一个统一的入口还是必要的，下面我们介绍下网关是什么并介绍zuul组件的使用。</p>
<h2 id="API-网关"><a href="#API-网关" class="headerlink" title="API 网关"></a><font color="#8B475D">API 网关</font></h2><blockquote>
<p><font color="#333">API网关是一个服务器，是系统的唯一入口。从面向对象设计的角度看，它与外观模式类似。API网关封装了系统内部架构，为每个客户端提供一个定制的API。它可能还具有其它职责，如身份验证、监控、负载均衡、缓存、请求分片与管理、静态响应处理。<br>API网关方式的核心要点是，所有的客户端和消费端都通过统一的网关接入微服务，在网关层处理所有的非业务功能。通常，网关也是提供REST/HTTP的访问API。服务端通过API-GW注册和管理服务。</font></p>
</blockquote>
<p>怎么理解呢？ 相当于说api网关是一个外界访问整个系统的统一资源的定位器，将一个业务系统内部的多个微服务进行封装，对外提供唯一访问入口，实现系统内高内聚，系统间通过网关交互达到松耦合的效果。</p>
<h5 id="单节点网关"><a href="#单节点网关" class="headerlink" title="#单节点网关"></a>#<font color="#367bdd">单节点网关</font></h5><p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher9-2.png" alt="image"></p>
<h5 id="Backends-for-frontends-网关"><a href="#Backends-for-frontends-网关" class="headerlink" title="#Backends for frontends 网关"></a>#<font color="#367bdd">Backends for frontends 网关</font></h5><p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher9-3.png" alt="image"></p>
<h2 id="API-网关的优缺点"><a href="#API-网关的优缺点" class="headerlink" title="API 网关的优缺点"></a><font color="#8B475D">API 网关的优缺点</font></h2><h5 id="优点"><a href="#优点" class="headerlink" title="#优点"></a>#<font color="#367bdd">优点</font></h5><p>封装了应用程序的内部结构。客户端只需要同网关交互，而不必调用特定的服务（统一API入口）。API 网关为每一类客户端提供了特定的 API ，从而减少客户端与应用程序间的交互次数，简化客户端代码的处理（集合多个API）。</p>
<p>另外，可以避免内部信息泄露给外部。可以为微服务添加额外的安全层。支持混合通信协议。降低构建微服务的复杂性。</p>
<h5 id="缺点"><a href="#缺点" class="headerlink" title="#缺点"></a>#<font color="#367bdd">缺点</font></h5><p>增加了一个必须开发、部署和维护的高可用组件。还有一个风险是 API 网关变成了开发瓶颈。为了暴露每个微服务，开发人员必须更新 API 网关。API 网关的更新过程要尽可能地简单，否则为了更新网关，开发人员将不得不排队等待。不过，虽然有这些不足，但对于大多数现实世界的应用程序而言使用 API 网关是合理的。（在架构上需要额外考虑更多编排和管理；路由逻辑配置要进行统一的管理；可能引发单点故障）</p>
<h2 id="Zuul"><a href="#Zuul" class="headerlink" title="Zuul"></a><font color="#8B475D">Zuul</font></h2><h5 id="Zuul的定义"><a href="#Zuul的定义" class="headerlink" title="#Zuul的定义"></a>#<font color="#367bdd">Zuul的定义</font></h5><p>Zuul是Spring Cloud全家桶中的微服务API网关。</p>
<p>所有从设备或网站来的请求都会经过<code>Zuul</code>到达后端的<code>Netflix</code>应用程序。作为一个边界性质的应用程序，<code>Zuul</code>提供了动态路由、监控、金丝雀测试、弹性负载和安全等功能。Zuul底层利用各种<code>filter</code>实现上面的功能。</p>
<h5 id="Zuul测试"><a href="#Zuul测试" class="headerlink" title="#Zuul测试"></a>#<font color="#367bdd">Zuul测试</font></h5><p>在之前的项目里面有<code>msa-weather-eureka-server</code>和<code>msa-weather-eureka-client</code>,一个启动端口是8761，另外一个使用默认的8080，基于<code>msa-weather-eureka-client</code>新建一个项目<code>msa-weather-eureka-client-zuul</code>，改动如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">zuul.routes.hi.path=/hi<span class="comment">/**</span></span><br><span class="line"><span class="comment">zuul.routes.hi.service-id=msa-weather-eureka-client</span></span><br></pre></td></tr></table></figure>

<p>这里的含义是：定义一个名字叫做hi的路由规则（自定义），我们访问<code>/hi/**</code> 这个路径的时候，就会转发到<code>msa-weather-eureka-client</code>这个服务下的路径。</p>
<p>比如我这里的<code>msa-weather-eureka-client</code>有一个<code>controller</code>路径为<code>&quot;hello&quot;</code>，调用<code>localhost:8081/hello</code>就可以返回一个字符串。那么有了<code>zuul</code>配置之后，我可以访问<code>localhost:8080/hi/hello</code>也可以访问到这个路径了。</p>
<h5 id="改造系统"><a href="#改造系统" class="headerlink" title="#改造系统"></a>#<font color="#367bdd">改造系统</font></h5><p>新建一个项目：<code>msa-eureka-client-zuul</code>。主要是定义网关的路由。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">spring.application.name=msa-weather-eureka-client-zuul</span></span><br><span class="line"><span class="string">eureka.client.service-url.defaultZone=http://localhost:8761/eureka</span></span><br><span class="line"></span><br><span class="line"><span class="string">zuul.routes.city.path=/city/**</span></span><br><span class="line"><span class="string">zuul.routes.city.service-id=msa-weather-city-eureka</span></span><br><span class="line"></span><br><span class="line"><span class="string">zuul.routes.data.path=/data/**</span></span><br><span class="line"><span class="string">zuul.routes.data.service-id=msa-weather-data-eureka</span></span><br></pre></td></tr></table></figure>

<p>ok，下面我们就修改<code>msa-weather-collection-cureka-feign</code>和<code>msa-weather-report-feign</code>.复制为新的项目：<code>msa-weather-collection-cureka-feign-zuul</code>和<code>msa-weather-report-feign-zuul</code></p>
<p>以<code>msa-weather-report-feign-zuul</code>为例，其实他依托于两个服务:<code>msa-weather-data-eureka</code>和<code>msa-weather-ciy-eureka</code>，这两个我们只需要写在一个接口内，调用网关里定义的路由即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@FeignClient</span>(<span class="string">"msa-weather-eureka-client-zuul"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DataClient</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取城市列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/city/cities"</span>)</span><br><span class="line">    <span class="function">List&lt;City&gt;  <span class="title">listCity</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据城市Id来查询天气数据</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cityId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/data/weather/cityId/&#123;cityId&#125;"</span>)</span><br><span class="line">    <span class="function">WeatherResponse <span class="title">getDataByCityId</span><span class="params">(@PathVariable(<span class="string">"cityId"</span>)</span> String cityId)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样子，这个<code>DataClient</code>就取代了之前的<code>cityClient</code>和<code>WeatherClient</code>。改造完成。</p>
<p>测试无问题。</p>
<p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher9-1.png" alt="image"></p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/02/08-天气预报系统-微服务的消费/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Gh">
      <meta itemprop="description" content="gratitude and love">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="To be or not to be?">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/10/02/08-天气预报系统-微服务的消费/" class="post-title-link" itemprop="url">08-天气预报系统-微服务的消费</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-10-02 16:54:11" itemprop="dateCreated datePublished" datetime="2019-10-02T16:54:11+08:00">2019-10-02</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/springcloud/" itemprop="url" rel="index"><span itemprop="name">springcloud</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">2.6k</span>
            </span>
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">2 分钟</span>
            </span>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在解决了服务注册和发现两个问题之后，就要解决服务消费问题了。本节重点介绍feign的使用。</p>
<h2 id="发现模式"><a href="#发现模式" class="headerlink" title="发现模式"></a><font color="#8B475D">发现模式</font></h2><h5 id="直连模式"><a href="#直连模式" class="headerlink" title="#直连模式"></a>#<font color="#367bdd">直连模式</font></h5><p>  直接去连接某个url，比较简单粗暴，但是不能实现负载均衡和高可用，使用比较少。</p>
<h5 id="客户端发现模式："><a href="#客户端发现模式：" class="headerlink" title="#客户端发现模式："></a>#<font color="#367bdd">客户端发现模式：</font></h5><ul>
<li>服务实例启动后，将自己的位置信息提交到服务注册表</li>
<li>客户端从服务注册表进行查询，来获取可用的服务实例</li>
<li>客户端自行使用负载均衡算法从多个服务实例中选择一个</li>
</ul>
<h5 id="服务端发现模式："><a href="#服务端发现模式：" class="headerlink" title="#服务端发现模式："></a>#<font color="#367bdd">服务端发现模式：</font></h5><p>负载均衡的实现在服务端。而客户端发现模式的负载均衡由客户端来实现。</p>
<h2 id="服务的消费者"><a href="#服务的消费者" class="headerlink" title="服务的消费者"></a><font color="#8B475D">服务的消费者</font></h2><p><code>Apache HttpClient</code>：这个比较简单，不再赘述。</p>
<p><code>Ribbon</code>: 基于客户端负载均衡工具。可以基于Http或者Tcp实现负载均衡。</p>
<p>直接根据服务的名字来消费，具体是连到哪一个具体的ip去消费是不用管的，因为他已经在客户端上做了一定的负载均衡算法，由他的算法来决定。</p>
<p><code>Febin</code>:</p>
<p>Feign是一个声明式的伪Http客户端，它使得写Http客户端变得更简单。使用Feign，只需要创建一个接口并注解。它具有可插拔的注解特性，可使用Feign 注解和JAX-RS注解。Feign支持可插拔的编码器和解码器。Feign默认集成了Ribbon，并和Eureka结合，默认实现了负载均衡的效果。</p>
<p>我们先来搞个demo测试一把！</p>
<h2 id="fegin"><a href="#fegin" class="headerlink" title="fegin"></a><font color="#8B475D">fegin</font></h2><p>首先，我们之前的工作中已经由了一个<code>Eureka server</code>，再拿一个叫做<code>msa-weather-city-server</code>的服务来测试。这个服务的主要功能是获取城市信息。</p>
<h5 id="引入依赖、添加注解"><a href="#引入依赖、添加注解" class="headerlink" title="#引入依赖、添加注解"></a>#<font color="#367bdd">引入依赖、添加注解</font></h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.2.0.RELEASE&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>在程序的启动类<code>WeatherApplication</code> ，加上<code>@EnableFeignClients</code>注解开启<code>Feign</code>的功能：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WeatherApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(WeatherApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="配置文件"><a href="#配置文件" class="headerlink" title="#配置文件"></a>#<font color="#367bdd">配置文件</font></h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server.port=<span class="number">8761</span></span><br><span class="line">eureka.instance.hostname=localhost</span><br><span class="line">eureka.client.register-with-eureka=<span class="keyword">false</span></span><br><span class="line">eureka.client.fetch-registry=<span class="keyword">false</span></span><br><span class="line">eureka.client.service-url.defaultZone=http:<span class="comment">//localhost:8761/eureka</span></span><br></pre></td></tr></table></figure>

<h5 id="定义feign接口"><a href="#定义feign接口" class="headerlink" title="#定义feign接口"></a>#<font color="#367bdd">定义feign接口</font></h5><p>定义一个<code>feign</code>接口，通过@ FeignClient（“服务名”），来指定调用哪个服务。比如在代码中调用了<code>msa-weather-city-eureka</code>服务的<code>/cities</code>接口来获取所有的城市列表，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(<span class="string">"msa-weather-city-eureka"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CityClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/cities"</span>)</span><br><span class="line">    <span class="function">String <span class="title">listCity</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="定义API来供浏览器调用"><a href="#定义API来供浏览器调用" class="headerlink" title="#定义API来供浏览器调用"></a>#<font color="#367bdd">定义API来供浏览器调用</font></h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CityClient cityClient;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"cities"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getData</span><span class="params">()</span></span>&#123;</span><br><span class="line">        String res = cityClient.listCity();</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，启动服务中心<code>Eureka server</code>和服务提供方<code>msa-weather-city-server</code>以及本消费服务。再浏览器中访问对应的url就可以调用<code>msa-weather-city-server</code>提供的服务。</p>
<h2 id="用Feign继续完善天气项目"><a href="#用Feign继续完善天气项目" class="headerlink" title="用Feign继续完善天气项目"></a><font color="#8B475D">用Feign继续完善天气项目</font></h2><p>有三个<code>TODO</code>项：</p>
<ul>
<li>数据采集微服务在天气数据同步任务中，依赖于城市数据API微服务</li>
<li>天气预报微服务查询天气信息，依赖于天气数据API微服务</li>
<li>天气预报微服务提供的城市列表，依赖于城市数据API微服务</li>
</ul>
<p>那么我们可以看出来，需要去集成Feign去消费的微服务只有两个：<code>msa-weather-collection-eureka</code>和<code>msa-weather-report-eureka</code>。我们将其改造为：<code>msa-weather-collection-eureka-feign</code>和<code>msa-weather-report-eureka-feign</code>。</p>
<p>这里就以<code>msa-weather-collection-eureka</code>为例，步骤基本与上面一样。首先是引入依赖，然后加上注解开启<code>Feign</code>功能。新建一个接口，还是获取城市列表。我只要指定好那个城市列表的微服务的名字和路径，就可以获取到了。不清楚直接看代码即可。</p>
<p>那么在全部改好之后，我们启动这五个项目。但是我们要注意，先启动<code>weather-eureka-server</code>，来提供注册的服务。然后启动城市数据服务，因为天气数据采集要用到他。然后启动天气数据采集服务。然后一次启动天气数据API服务和天气预报UI显示服务。</p>
<p>那么我们访问天气预报UI对应的URL,以郑州为例：<br><code>http://localhost:8083/report/cityId/101180101</code>，如果功能是正常的，标识微服务改造初步成功。</p>
<p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher8-3.png" alt="image"></p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/30/07-天气预报系统-微服务的注册和发现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Gh">
      <meta itemprop="description" content="gratitude and love">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="To be or not to be?">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/09/30/07-天气预报系统-微服务的注册和发现/" class="post-title-link" itemprop="url">07-天气预报系统-微服务的注册和发现</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-09-30 16:54:11" itemprop="dateCreated datePublished" datetime="2019-09-30T16:54:11+08:00">2019-09-30</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/springcloud/" itemprop="url" rel="index"><span itemprop="name">springcloud</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">4.8k</span>
            </span>
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">4 分钟</span>
            </span>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文主要介绍eureka的使用，还有服务的注册与发现。</p>
<h2 id="什么是spring-cloud"><a href="#什么是spring-cloud" class="headerlink" title="什么是spring cloud"></a><font color="#8B475D">什么是spring cloud</font></h2><p><code>Spring Cloud</code>是一系列框架的有序集合。它利用<code>Spring Boot</code>的开发便利性巧妙地简化了分布式系统基础设施的开发，如服务发现注册、配置中心、消息总线、负载均衡、断路器、数据监控等，都可以用<code>Spring Boot</code>的开发风格做到一键启动和部署。<code>Spring</code>并没有重复制造轮子，它只是将目前各家公司开发的比较成熟、经得起实际考验的服务框架组合起来，通过<code>Spring Boot</code>风格进行再封装屏蔽掉了复杂的配置和实现原理，最终给开发者留出了一套简单易懂、易部署和易维护的分布式系统开发工具包。</p>
<p>微服务是可以独立部署、水平扩展、独立访问（或者有独立的数据库）的服务单元，<code>spring cloud</code>就是这些微服务的大管家，采用了微服务这种架构之后，项目的数量会非常多，<code>spring cloud</code>做为大管家需要管理好这些微服务，自然需要很多小弟来帮忙。</p>
<p>解决了分布式系统中的一些问题:配置管理、服务注册、服务发现、断路器、智能路由、负载均衡、服务间调用、一次性令牌、全局锁、领导选举、控制总线、思维导图、分布式会话、集群状态、分布式消息。。。</p>
<h2 id="spring-cloud和spring-boot的关系"><a href="#spring-cloud和spring-boot的关系" class="headerlink" title="spring cloud和spring boot的关系"></a><font color="#8B475D">spring cloud和spring boot的关系</font></h2><p><code>SpringBoot</code>是构建<code>spring cloud</code>架构的基石。</p>
<h2 id="Eureka"><a href="#Eureka" class="headerlink" title="Eureka"></a><font color="#8B475D">Eureka</font></h2><h5 id="服务中心"><a href="#服务中心" class="headerlink" title="#服务中心"></a>#<font color="#367bdd">服务中心</font></h5><p>服务中心又称注册中心，管理各种服务功能包括服务的注册、发现、熔断、负载、降级等各种功能。</p>
<p>有了服务中心调用关系会有什么变化，画几个简图来帮忙理解.<br>比如我们前面天气微服务需要调用天气数据服务的数据来展示给前端</p>
<p>项目A调用项目B</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">天气预报微服务--&gt;天气数据API</span><br></pre></td></tr></table></figure>

<p>有了服务中心之后，任何一个服务都不能直接去掉用，都需要通过服务中心来调用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">graph LR</span><br><span class="line">天气预报微服务--&gt;注册中心再去访问天气数据API</span><br></pre></td></tr></table></figure>

<h5 id="Eureka-1"><a href="#Eureka-1" class="headerlink" title="#Eureka"></a>#<font color="#367bdd">Eureka</font></h5><ul>
<li><code>Spring Cloud</code> 封装了 <code>Netflix</code> 公司开发的 <code>Eureka</code> 模块来实现服务注册和发现。</li>
<li><code>Eureka Server</code> 作为服务注册功能的服务器，它是服务注册中心。而系统中的其他微服务，使用 <code>Eureka</code> 的客户端连接到 <code>Eureka Server</code>，并维持心跳连接。</li>
<li>这样系统的维护人员就可以通过 <code>Eureka Server</code> 来监控系统中各个微服务是否正常运行。</li>
<li><code>Spring Cloud</code> 的一些其他模块（比如<code>Zuul</code>）就可以通过 <code>Eureka Server</code> 来发现系统中的其他微服务，并执行相关的逻辑。</li>
<li><code>Eureka</code>由两个组件组成：<code>Eureka</code>服务器和<code>Eureka</code>客户端。<code>Eureka</code>服务器用作服务注册服务器。<code>Eureka</code>客户端是一个java客户端，用来简化与服务器的交互、作为轮询负载均衡器，并提供服务的故障切换支持。</li>
</ul>
<p><img src="http://blog-picture-g.test.upcdn.net/weather/7-1.jpg" alt="image"></p>
<p>其中有三个角色：</p>
<ul>
<li><code>Eureka Server</code>：提供服务注册和发现</li>
<li><code>Service Provider</code>服务提供方，将自身服务注册到<code>Eureka</code>，从而使服务消费方能够找到</li>
<li><code>Service Consumer</code>：服务消费方，从<code>Eureka</code>获取注册服务列表，从而能够消费服务</li>
</ul>
<h5 id="Eureka-Server"><a href="#Eureka-Server" class="headerlink" title="#Eureka Server"></a>#<font color="#367bdd">Eureka Server</font></h5><p>新建一个springboot项目。spring cloud已经帮我实现了服务注册中心，我们只需要很简单的几个步骤就可以完成。</p>
<p>为了学习不出差错演示的springboot版本和springcloud版本并没有用最新的版本，因为springBoot和spring cloud的版本对应关系，需要配套使用，才不会出现各种奇怪的错误。项目中springboot的版本<code>&lt;version&gt;2.1.0.RELEASE&lt;/version&gt;</code>,springcloud版本<code>&lt;version&gt;Finchley.RELEASE&lt;/version&gt;</code></p>
<p>1、pom中添加依赖</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencyManagement&gt;</span><br><span class="line">        &lt;dependencies&gt;</span><br><span class="line">            &lt;dependency&gt;</span><br><span class="line">                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;Finchley.RELEASE&lt;/version&gt;</span><br><span class="line">                &lt;type&gt;pom&lt;/type&gt;</span><br><span class="line">                &lt;scope&gt;import&lt;/scope&gt;</span><br><span class="line">            &lt;/dependency&gt;</span><br><span class="line">        &lt;/dependencies&gt;</span><br><span class="line">&lt;/dependencyManagement&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">            &lt;exclusions&gt;</span><br><span class="line">                &lt;exclusion&gt;</span><br><span class="line">                    &lt;groupId&gt;org.junit.vintage&lt;/groupId&gt;</span><br><span class="line">                    &lt;artifactId&gt;junit-vintage-engine&lt;/artifactId&gt;</span><br><span class="line">                &lt;/exclusion&gt;</span><br><span class="line">            &lt;/exclusions&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.18.4&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.junit.jupiter&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;junit-jupiter-api&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;RELEASE&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<p>2、添加启动代码中添加@EnableEurekaServer注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MicroWeatherEurekaClientApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(MicroWeatherEurekaClientApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、配置文件</p>
<p>在默认设置下，该服务注册中心也会将自己作为客户端来尝试注册它自己，所以我们需要禁用它的客户端注册行为，在<code>application.yml</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server.port=<span class="number">8761</span></span><br><span class="line">eureka.instance.hostname=localhost</span><br><span class="line">eureka.client.register-with-eureka=<span class="keyword">false</span></span><br><span class="line">eureka.client.fetch-registry=<span class="keyword">false</span></span><br><span class="line">eureka.client.service-url.defaultZone=http:<span class="comment">//localhost:8761/eureka</span></span><br></pre></td></tr></table></figure>

<p>启动工程后，访问：<a href="http://localhost:8761/" target="_blank" rel="noopener">http://localhost:8761/</a> ，可以看到下面的页面，其中还没有发现任何服务</p>
<p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher8-1.png" alt="image"></p>
<h5 id="Eureka-Client"><a href="#Eureka-Client" class="headerlink" title="#Eureka Client"></a>#<font color="#367bdd">Eureka Client</font></h5><p>基本与上一个是类似的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br></pre></td></tr></table></figure>

<p>主要的配置文件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spring.application.name=msa-weather-city-eureka</span><br><span class="line">eureka.client.service-url.defaultZone=http:<span class="comment">//localhost:8761/eureka</span></span><br><span class="line">server.port=<span class="number">8084</span></span><br></pre></td></tr></table></figure>

<p>这样同时启动<code>Eureka Server</code>和<code>Eureka Client</code>两个工程。在网站中输入<code>localhost://8761</code>就可以看到注册到<code>Eureka Server</code>的实例了。</p>
<h2 id="本门实战"><a href="#本门实战" class="headerlink" title="本门实战"></a><font color="#8B475D">本门实战</font></h2><p>将之前的四个微服务改造为eureka的客户端。</p>
<p><code>mas-weather-collection-server</code></p>
<p><code>mas-weather-report-server</code></p>
<p><code>mas-weather-data-server</code></p>
<p><code>mas-weather-city-server</code></p>
<p>改为：</p>
<p><code>mas-weather-collection-eureka</code></p>
<p><code>mas-weather-report-eureka</code></p>
<p><code>mas-weather-data-eureka</code></p>
<p><code>mas-weather-city-eureka</code></p>
<p>改造过程十分简单，就是引入依赖，修改配置即可。</p>
<p>同时启动这四个微服务客户端和一个<code>eureka</code>服务端。</p>
<p>我们可以看到：</p>
<p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher8-2.png" alt="image"></p>
<p>下面，这些微服务之间可以相互访问了。</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/29/06-天气预报系统-拆分系统/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Gh">
      <meta itemprop="description" content="gratitude and love">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="To be or not to be?">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/09/29/06-天气预报系统-拆分系统/" class="post-title-link" itemprop="url">06-天气预报系统-拆分系统</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-09-29 16:54:11" itemprop="dateCreated datePublished" datetime="2019-09-29T16:54:11+08:00">2019-09-29</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/springcloud/" itemprop="url" rel="index"><span itemprop="name">springcloud</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">1.4k</span>
            </span>
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">1 分钟</span>
            </span>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>前面我们说到先把系统拆分为四个服务，还没有进行服务治理，只是一个简单的业务拆分，为下面做准备。</p>
<p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher7-1.png" alt="image"></p>
<h2 id="天气数据采集微服务"><a href="#天气数据采集微服务" class="headerlink" title="天气数据采集微服务"></a><font color="#8B475D">天气数据采集微服务</font></h2><p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher7-2.png" alt="image"></p>
<p>这个微服务专门提供数据采集和定时更新功能，将数据存储在<code>redis</code>中。</p>
<p>该服务的核心<code>service</code>中的方法是：<code>syncDataByCityId</code>，就是根据<code>cityId</code>来将数据同步进<code>redis</code>。</p>
<h2 id="天气数据API"><a href="#天气数据API" class="headerlink" title="天气数据API"></a><font color="#8B475D">天气数据API</font></h2>


<p>这个服务专门来提供天气数据的查询功能。</p>
<p>将前端页面以及定时、城市相关的代码全部删除。只留下两个API：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">WeatherResponse <span class="title">getDataByCityId</span><span class="params">(String cityId)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">WeatherResponse <span class="title">getDataByCityName</span><span class="params">(String cityName)</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="天气预报微服务"><a href="#天气预报微服务" class="headerlink" title="天气预报微服务"></a><font color="#8B475D">天气预报微服务</font></h2>

<p>本服务的主要功能为：用户通过浏览器来访问，可以返回一个天气预报的界面。</p>
<p>就将redis和定时任务相关的都删掉。我们只需要一个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Weather <span class="title">getDataByCityId</span><span class="params">(String cityId)</span></span>;</span><br></pre></td></tr></table></figure>

<p>因为展示数据需要用到城市信息，但是此时还没有，所以需要自己去模拟一些数据去显示。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ModelAndView <span class="title">getReportByCityId</span><span class="params">(@PathVariable(<span class="string">"cityId"</span>)</span> String cityId, Model model) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">       <span class="comment">//TODO 改为由城市数据API微服务来提供数据</span></span><br><span class="line">       List&lt;City&gt; cityList = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">try</span>&#123;</span><br><span class="line">           <span class="comment">//TODO 改为由城市数据API微服务来提供数据</span></span><br><span class="line">           cityList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">           City city = <span class="keyword">new</span> City();</span><br><span class="line">           city.setCityId(<span class="string">"101180101"</span>);</span><br><span class="line">           city.setProvince(<span class="string">"郑州"</span>);</span><br><span class="line">           cityList.add(city);</span><br><span class="line">       &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">           log.error(<span class="string">"Exception"</span>,e);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="comment">//</span></span><br><span class="line">       model.addAttribute(<span class="string">"title"</span>,<span class="string">"糖糖的天气预报"</span>);</span><br><span class="line">       model.addAttribute(<span class="string">"cityId"</span>,cityId);</span><br><span class="line">       model.addAttribute(<span class="string">"cityList"</span>,cityList);</span><br><span class="line">       model.addAttribute(<span class="string">"report"</span>,weatherReportService.getDataByCityId(cityId));</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> ModelAndView(<span class="string">"weather/report"</span>,<span class="string">"reportModel"</span>,model);</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h2 id="城市数据API"><a href="#城市数据API" class="headerlink" title="城市数据API"></a><font color="#8B475D">城市数据API</font></h2>

<p>本服务只提供城市列表数据功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">List&lt;City&gt; <span class="title">listCity</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</span><br></pre></td></tr></table></figure>

<p>和上面一样需要填充一些假数据，方便测试。</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/27/05-天气预报系统-服务拆分/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Gh">
      <meta itemprop="description" content="gratitude and love">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="To be or not to be?">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/09/27/05-天气预报系统-服务拆分/" class="post-title-link" itemprop="url">05-天气预报系统-服务拆分</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-09-27 16:54:11" itemprop="dateCreated datePublished" datetime="2019-09-27T16:54:11+08:00">2019-09-27</time>
            </span>
          

          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/springcloud/" itemprop="url" rel="index"><span itemprop="name">springcloud</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          <br>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">3.2k</span>
            </span>
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">3 分钟</span>
            </span>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>至此我们完成了天气预报基本的一些功能，因为这个课程是一个微服务的课程，下面我们后面来学习如何将服务拆分开来，初步认识下什么是SOA架构，什么是微服务。</p>
<h2 id="单体架构"><a href="#单体架构" class="headerlink" title="单体架构"></a><font color="#8B475D">单体架构</font></h2><p>我们熟悉的MVC架构就是一个单体架构。</p>
<p>用户&lt;—&gt;表示层(<code>controller</code>)&lt;—&gt;业务层(<code>service</code>)&lt;—&gt;数据访问层(<code>dao</code>)&lt;—&gt;数据库</p>
<p>单块结构的优缺点：</p>
<table>
<thead>
<tr>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>功能划分清楚</td>
<td>功能仍然太大</td>
</tr>
<tr>
<td>层次关系良好</td>
<td>支付周期变长</td>
</tr>
<tr>
<td>每一层独立</td>
<td>升级风险高</td>
</tr>
<tr>
<td>部署简单</td>
<td>维护成本增加</td>
</tr>
<tr>
<td>技术单一</td>
<td>可伸缩性差</td>
</tr>
<tr>
<td>用人成本低</td>
<td>监控困难</td>
</tr>
</tbody></table>
<h2 id="单体架构如何转化为微服务"><a href="#单体架构如何转化为微服务" class="headerlink" title="单体架构如何转化为微服务"></a><font color="#8B475D">单体架构如何转化为微服务</font></h2><h5 id="什么是SOA？"><a href="#什么是SOA？" class="headerlink" title="#什么是SOA？"></a>#<font color="#367bdd">什么是SOA？</font></h5><blockquote>
<p><code>SOA</code>是一种设计方法，其中包含多个服务，而服务之间通过配合最终会提供一系列功能。一个服务通常以独立的形式存在于操作系统进程中。服务之间通过网络调用，而非采用进程内调用的方式进行通信。</p>
</blockquote>
<h5 id="SOA和微服务的理解"><a href="#SOA和微服务的理解" class="headerlink" title="#SOA和微服务的理解"></a>#<font color="#367bdd">SOA和微服务的理解</font></h5><p>怎么去理解那，我在网上找到一个段子，比较容易理解SOA和微服务：</p>
<blockquote>
<p>话说1979年，又是一个春天，莆田乡下的赤脚医生吴大牛被改革的春风吹的心潮澎湃，说干就干，吴大牛趁着夜色朦胧找大队支书汇报了思想，第二天就承包了村卫生室，开启了自己的在医疗圈的传奇历程。乡村诊所大家都知道，没什么复杂的东东，房子只有一间，一个大柜台中间隔开，一半是诊疗兼候诊区，一半是药房，看病就直接找医生，如果前面有人就自己找个位子坐下，排队等一会，秩序倒也井然，看完病了医生直接给抓药，然后下一个继续，也不需要护士和药剂师，吴大牛一个人全部包办。</p>
</blockquote>
<blockquote>
<p>辛辛苦苦忙碌了十年，时间来到了八九年，又是一个春天，昔日的单身汉吴大牛已成为十里八乡的知名人物，媳妇娶上了不说，家里还增加了一对双胞胎儿子，二层的小洋房也甚是气派。可是也有烦心事，尽管乡村诊所扩大到了两间，媳妇还偶尔能去帮帮忙，但是医生还是只有自己一个，天天从早忙到晚挣的都是一份钱，想多挣点怎么办？吴大牛日思夜想，还真给他想出来一招，怎么办，扩大规模，多招几个医生一起干。原来吴大牛只能治头疼脑热和跌打损伤，现在新招了一个医科大学的毕业生刘小明专治疑难杂症，又从邻村请来了老大夫李阿花专治妇科病，现在一个普通的小诊所就变成了有三个独立科室加一个公共药房（吴大牛媳妇负责）的小医院了，吴大牛是外科主任兼院长，收入那可比之前翻了三番。人逢喜事精神爽，大牛院长请县里的书法名家为新医院书写了牌匾–“博爱医院”，挑了一个黄道吉日正式挂了上去。</p>
</blockquote>
<blockquote>
<p>一晃十年过去了，又是一个春天，吴大牛的博爱医院已经发展到了内科外科妇科五官科骨科生殖科六个科室，每个科室3到5名医生不等，也耗费巨资购进了血夜化验B超等先进仪器，大牛院长也早已脱离了医疗一线，成为了专职的管理者，但是医院的大事小事大家都找他，就这三十多号员工搞的他每天是焦头烂额，想再扩大规模实在是有心无力了。要说还是大学生有水平，老部下刘小明给大牛院长献了一计，把各个科室独立出去，让各个科室主任自己管理，大牛院长只管科室之间的协调和医院发展的大事，这样既能调动基层的积极性，又能把大牛院长解放出来扩大生产抓大事谋大事，岂不妙哉？就这样，博爱医院的新一轮改革轰轰烈烈的展开了。</p>
</blockquote>
<blockquote>
<p>又是一个十年，还是在哪个春天，大牛院长已成为本地知名的企业家，博爱医院也发展到了二十三个科室数百名员工，发展中也出现了新问题，由于各个科室独立挂号、收费、化验，有的科室整天忙忙碌碌效益好，有的科室就相对平庸些，连分到的各种检查仪器都不能满负荷运行，整个医院养了不少闲人。这时候大牛院长视野也开阔了，请来了管理专家进行了顶层设计，把原来分散到各个科室的非核心服务全部收归集中管理，把原来二十三个挂号窗口整合为十个，二十三个收费窗口整合为八个，集中布设在一楼大厅为全院服务，还把分散在各个科室的检查仪器集中起来成立独立的检验科，也为全院服务，这样人人有活干，整个医院的服务能力又上了一个新台阶，这轮改革后博爱医院通过了各级部门的鉴定成为了远近驰名的三甲医院，吴大牛也换身一变成为了博爱集团的CEO兼董事长，下一步就准备IPO上市了。</p>
</blockquote>
<blockquote>
<p>说到这里大家可能有点糊涂，这个跟微服务有嘛关系？<br>大牛诊所的1.0阶段就相当于软件开发的单体结构，一个程序员打天下，从头编到尾，很难做大做强。<br>大牛诊所的2.0阶段就相当于软件开发的垂直结构，各科室按照业务划分，很容易横向扩展。<br>博爱医院的1.0阶段就相当于软件开发的SOA结构，除了药房（数据库）外各个服务独立提供（科室主任负责），但需要大牛院长（ESB总线）来协调。<br>博爱医院的2.0阶段就相当于软件开发的微服务结构，公共服务院内共享，科室主任管理功能弱化（只管医生业务），优点是扩容方便，哪个部门缺人直接加，不用看上下游，资源利用率高，人员和设备效率高。<br>为什么要变呢？小诊所有小诊所的活法，大医院有大医院的骄傲。无他，天下熙熙，皆为利来；天下攘攘，皆为利往。<br><a href="https://blog.csdn.net/HistoryCreator/article/details/89059711" target="_blank" rel="noopener">https://blog.csdn.net/HistoryCreator/article/details/89059711</a></p>
</blockquote>
<h5 id="设计原则"><a href="#设计原则" class="headerlink" title="#设计原则"></a>#<font color="#367bdd">设计原则</font></h5><ul>
<li>拆分足够微：划分比较细，但是也不能太细，增加管理问题</li>
<li>轻量级通信：rest，rpc等方式在网络上通信</li>
<li>单一职责原则：高内聚，低耦合，确定服务边界</li>
</ul>
<h2 id="微服务系统设计"><a href="#微服务系统设计" class="headerlink" title="微服务系统设计"></a><font color="#8B475D">微服务系统设计</font></h2><p><strong>服务拆分</strong>—-》<strong>服务注册</strong>—-》<strong>服务发现</strong>—-》<strong>服务消费</strong>(调用另外一个服务)—-》<strong>统一入口</strong>(服务很多的时候难以管理需要有一个统一的入口)—-》<strong>配置管理</strong>(管理每个服务的配置信息)—-》<strong>熔断机制</strong>(保护系统避免崩溃)—-》<strong>自动扩展</strong>(根据负荷自动扩展集群)</p>
<h2 id="微服务拆分的意义"><a href="#微服务拆分的意义" class="headerlink" title="微服务拆分的意义"></a><font color="#8B475D">微服务拆分的意义</font></h2><ul>
<li>易于实现</li>
<li>易于部署</li>
<li>易于维护</li>
<li>易于更新</li>
</ul>
<p>我们天气预报系统可以差分为：</p>
<ul>
<li>天气数据采集服务：数据采集和数据存储</li>
<li>天气预报服务：数据展示</li>
<li>天气数据API：数据查询</li>
<li>城市数据API：数据查询</li>
</ul>
<h2 id="现有天气预报体统的弊端"><a href="#现有天气预报体统的弊端" class="headerlink" title="现有天气预报体统的弊端"></a><font color="#8B475D">现有天气预报体统的弊端</font></h2><h5 id="弊端"><a href="#弊端" class="headerlink" title="#弊端"></a>#<font color="#367bdd">弊端</font></h5><ul>
<li>大而全，所有功能都掺杂在一起，混杂了太多的功能，不满足软件设计的单一职责原则。</li>
<li>难以理解，当我们这个项目越来越大，系统的代码量会越来越对，让我们难以理解，从而倒置难以维护，也不利于扩展。</li>
</ul>
<h5 id="改造需求"><a href="#改造需求" class="headerlink" title="#改造需求"></a>#<font color="#367bdd">改造需求</font></h5><p>那问题出来了，为了解决“大而全”的问题需要把当前的业务拆分细化，服务模块的业务尽量单一。微服务可以支持水平扩展，如果有需要还应能实现微服务间的简单调用。</p>
<h2 id="项目拆分"><a href="#项目拆分" class="headerlink" title="项目拆分"></a><font color="#8B475D">项目拆分</font></h2><h5 id="不同模块拆分"><a href="#不同模块拆分" class="headerlink" title="#不同模块拆分"></a>#<font color="#367bdd">不同模块拆分</font></h5><p>上面我们说到了如何将项目拆分成不同的模块，保持每个模块功能尽量单一。</p>
<ul>
<li>天气数据采集服务：数据采集和数据存储</li>
<li>天气预报服务：数据展示</li>
<li>天气数据API：数据查询</li>
<li>城市数据API：数据查询</li>
</ul>
<p>我们将根据原来项目中不同的业务中的相互调用来这样拆分：</p>
<p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher6-1.png" alt="image"></p>
<h5 id="代码拆分"><a href="#代码拆分" class="headerlink" title="#代码拆分"></a>#<font color="#367bdd">代码拆分</font></h5><p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher6-2.png" alt="image"></p>
<h5 id="数据流向"><a href="#数据流向" class="headerlink" title="#数据流向"></a>#<font color="#367bdd">数据流向</font></h5><p>项目中我们数据有两块来源，1是第三方的天气数据根据第三方api获取，2是城市数据列表我们可以直接储存在xml文件中，根据城市api来获取。</p>
<p>我们第三方天气数据服务根据城市列表服务来采集数据，同时城市列表服务也将提供给天气预报服务。具体数据流向如下图所示：</p>
<p><img src="http://blog-picture-g.test.upcdn.net/weather/weaher6-3.png" alt="image"></p>
<h2 id="通信设计"><a href="#通信设计" class="headerlink" title="通信设计"></a><font color="#8B475D">通信设计</font></h2><ul>
<li>天气数据接口：<ul>
<li>城市ID调用方式：<code>Get/weather/cityId/{cityId}</code></li>
<li>参数：<code>cityId</code>为城市<code>ID</code></li>
<li>城市名称调用方式：<code>Get/weather/cityName/{cityName}</code></li>
<li>参数：<code>cityName</code>为城市名称</li>
</ul>
</li>
<li>天气预报接口<ul>
<li>调用方式：<code>Get/report/cityId/{cityId}</code></li>
<li>参数：<code>cityId</code>为城市<code>ID</code></li>
</ul>
</li>
<li>城市数据接口<ul>
<li>调用方式：<code>Get.citys</code></li>
<li>参数：无（根据xml列表获取）</li>
</ul>
</li>
</ul>
<h2 id="存储设计"><a href="#存储设计" class="headerlink" title="存储设计"></a><font color="#8B475D">存储设计</font></h2><p>我们这个项目没有用到传统关系型数据库，因为数据不需要频繁的保存历史记录所以适用于<code>NoSql</code>方式，将数据存储在<code>redis</code>中可以提高访问速度和第三方接口的调用，相对于传统关系型数据库更有优势。</p>
<p>城市列表存储在xml文件中，城市列表基本上不变所以比较适合直接存储在静态文件中。</p>

          
        
      
    </div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/26/32-责任链模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Gh">
      <meta itemprop="description" content="gratitude and love">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="To be or not to be?">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/09/26/32-责任链模式/" class="post-title-link" itemprop="url">32-责任链模式</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-09-26 09:48:48" itemprop="dateCreated datePublished" datetime="2019-09-26T09:48:48+08:00">2019-09-26</time>
            </span>
          

          

          

          
            
            
          

          
          

          

          

          <br>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">3.8k</span>
            </span>
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">3 分钟</span>
            </span>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>本文我们来了解下责任链模式。<br>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/2019/09/26/32-责任链模式/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </p></div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/09/25/31-策略模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Gh">
      <meta itemprop="description" content="gratitude and love">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="To be or not to be?">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/09/25/31-策略模式/" class="post-title-link" itemprop="url">31-策略模式</a>
              
            
          </h1>
        

        <div class="post-meta">

          
          
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-09-25 16:11:48" itemprop="dateCreated datePublished" datetime="2019-09-25T16:11:48+08:00">2019-09-25</time>
            </span>
          

          

          

          
            
            
          

          
          

          

          

          <br>
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span title="本文字数">2.7k</span>
            </span>
          

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span title="阅读时长">2 分钟</span>
            </span>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>本文我们来了解下策略模式。<br>
          <!--noindex-->
          
            <div class="post-button text-center">
              <a class="btn" href="/2019/09/25/31-策略模式/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          
          <!--/noindex-->
        
      
    </p></div>

    

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/19/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><span class="page-number current">20</span><a class="page-number" href="/page/21/">21</a><span class="space">&hellip;</span><a class="page-number" href="/page/33/">33</a><a class="extend next" rel="next" href="/page/21/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Gh">
            
              <p class="site-author-name" itemprop="name">Gh</p>
              <div class="site-description motion-element" itemprop="description">gratitude and love</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">329</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com" title="GitHub &rarr; https://github.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://weibo.com/yourname" title="Weibo &rarr; https://weibo.com/yourname" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://stackoverflow.com/yourname" title="StackOverflow &rarr; https://stackoverflow.com/yourname" rel="noopener" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://www.bilibili.com/" title="blibili &rarr; https://www.bilibili.com/" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i>blibili</a>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-说明"></i>
                📢📢📢：站点除刷题笔记和课程笔记以外部分文章并非原创，只为学习复习使用😄😄😄
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="/">🔝</a>
                  </li>
                
              </ul>
            </div>
          

          
        </div>
      </div>

      

      

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Gh</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">861k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">13:03</span>
  
</div>








        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>










  
  





  
    
    
  
  <script color="0,0,0" opacity="0.5" zindex="-1" count="150" src="/lib/canvas-nest/canvas-nest.min.js"></script>









  
  <script src="/lib/jquery/index.js?v=3.4.1"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>




  <script src="/js/utils.js?v=7.2.0"></script>

  <script src="/js/motion.js?v=7.2.0"></script>



  
  


  <script src="/js/affix.js?v=7.2.0"></script>

  <script src="/js/schemes/pisces.js?v=7.2.0"></script>



  

  <script src="/js/next-boot.js?v=7.2.0"></script>

  

  

  

  

  



  




  

  

  

  

  

  

  

  

  

  

  

  

  


  
  
  

  

</body>
</html>
